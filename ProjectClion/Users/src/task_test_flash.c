//**************************************************************************************************
// @Module        TASK_TEST_FLASH
// @Filename      task_test_flash.c
//--------------------------------------------------------------------------------------------------
// @Platform      STM32
//--------------------------------------------------------------------------------------------------
// @Compatible    STM32L151
//--------------------------------------------------------------------------------------------------
// @Description   Implementation of the TASK_SENSOR_READ functionality.
//
//
//                Abbreviations:
//                  None.
//
//
//                Global (public) functions:
//
//
//                Local (private) functions:
//
//
//
//--------------------------------------------------------------------------------------------------
// @Version       1.0.0
//--------------------------------------------------------------------------------------------------
// @Date          XX.XX.XXXX
//--------------------------------------------------------------------------------------------------
// @History       Version  Author      Comment
// XX.XX.XXXX     1.0.0    KPS         First release.
//**************************************************************************************************



//**************************************************************************************************
// Project Includes
//**************************************************************************************************

// Native header
#include "task_test_flash.h"
// drivers
#include "W25Q_drv.h"
#include "checksum.h"
#include "printf.h"
#include "stdlib.h"
#include "ftoa.h"
// FreeRtos
#include "FreeRTOS.h"
#include "task.h"


//**************************************************************************************************
// Verification of the imported configuration parameters
//**************************************************************************************************

// None.


//**************************************************************************************************
// Definitions of global (public) variables
//**************************************************************************************************

// None.



//**************************************************************************************************
// Declarations of local (private) data types
//**************************************************************************************************

// None.


//**************************************************************************************************
// Definitions of local (private) constants
//**************************************************************************************************

#define SIZE_BUF            (512U-1U)



//**************************************************************************************************
// Definitions of static global (private) variables
//**************************************************************************************************

uint8_t dataRead[512];
uint8_t dataWrite[512];


//**************************************************************************************************
// Declarations of local (private) functions
//**************************************************************************************************

// None.


//**************************************************************************************************
//==================================================================================================
// Definitions of global (public) functions
//==================================================================================================
//**************************************************************************************************


//**************************************************************************************************
// @Function      vTaskTestFlash()
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void vTaskTestFlash(void *pvParameters)
{
    STD_RESULT result = RESULT_NOT_OK;
    uint64_t ID;
    uint16_t ManufID;
    uint32_t adr=W25Q_CAPACITY_SECTOR_BYTES;

    W25Q_Init();

    for (int i =0;i<SIZE_BUF;i++)
    {
        dataWrite[i] = rand()%100;
    }
    dataWrite[SIZE_BUF] = CH_SUM_CalculateCRC8(dataWrite, SIZE_BUF-1);

    W25Q_ReadUniqueID(&ID);
    W25Q_ReadManufactureID(&ManufID);

    vTaskDelay(1000/portTICK_RATE_MS);

    taskENTER_CRITICAL();

    W25Q_EraseBlock(adr,W25Q_BLOCK_MEMORY_4KB);
    W25Q_WriteData(adr,dataWrite,SIZE_BUF+1);

    taskEXIT_CRITICAL();

    while(1)
    {
        taskENTER_CRITICAL();

        W25Q_ReadData(adr,dataRead, SIZE_BUF+1);

        if ( dataRead[SIZE_BUF] == CH_SUM_CalculateCRC8(dataRead, SIZE_BUF-1))
        {
            printf("Test 1 PASS\n\r");
        }
        else
        {
            printf("Test 1 FAIL\n\r");
        }

        taskEXIT_CRITICAL();

        //printf("%d\n\r",rand()%100);

        vTaskDelay(1000/portTICK_RATE_MS);
    }
}// end of vTaskSensorsRead



//**************************************************************************************************
//==================================================================================================
// Definitions of local (private) functions
//==================================================================================================
//**************************************************************************************************

//**************************************************************************************************
// @Function      AM2305_DQLow()
//--------------------------------------------------------------------------------------------------
// @Description   Set low level on DQ pin
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************

// None.

//****************************************** end of file *******************************************








